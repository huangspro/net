#include "base_class/Layer.h"
#include<iostream>

using namespace std;

int main(){
  InputLayer* I=new InputLayer(1);
  NonlinearLayer* N1=new NonlinearLayer(1, NonlinearLayer::TANH);
  MeanSquareErrorLayer* M=new MeanSquareErrorLayer(1);
  NonlinearLayer* N2=new NonlinearLayer(50, NonlinearLayer::TANH);
  NonlinearLayer* N3=new NonlinearLayer(1, NonlinearLayer::LINEAR);
  HiddenLayer* H1=new HiddenLayer(50,1);
  HiddenLayer* H2=new HiddenLayer(1,50);
  
  N1->connect_to_last_layer_output(I->layer_output);
  N1->connect_to_next_layer_input(H1->input);
  N2->connect_to_last_layer_output(H1->layer_output);
  N2->connect_to_next_layer_input(H2->input);
  N3->connect_to_last_layer_output(H2->layer_output);
  N3->connect_to_next_layer_input(M->input);
  
  std::vector<std::vector<double>> inputdata = {
    //{697}, {696}, {695}, {694}, {693}, {692}, {691}, {690}, {689}, {688},
    //{687}, {686}, {685}, {684}, {683}, {682}, {681}, {680}, {679}, {678},
    //{677}, {676}, {675}, {674}, {673}, {672}, {671}, {670}, {669}, {668},
    //{667}, {666}, {665}, {664}, {663}, {662}, {661}, {660}, {659}, {658},
    //{657}, {656}, {655}, {654}, {653}, {652}, {651}, {650}, {649}, {648},
    //{647}, {646}, {645}, {644}, {643}, {642}, {641}, {640}, {639}, {638},
    //{637}, {636}, {635}, {634}, {633}, {632}, {631}, {630}, {629}, {628},
    {627}, {626}, {625}, {624}, {623}, {622}, {621}, {620}, {619}, {618},
    {617}, {616}, {615}, {614}, {613}, {612}, {611}, {610}, {609}, {608},
    {607}, {606}, {605}, {604}, {603}, {602}, {601}, {600}, {599}, {598},
    {597}, {596}, {595}, {594}, {593}, {592}, {591}, {590}, {589}, {588},
    {587}, {586}, {585}, {584}, {583}, {582}, {581}, {580}, {579}, {578},
    {577}, {576}, {575}, {574}, {573}, {572}, {571}, {570}, {569}, {568},
    {567}, {566}, {565}, {564}, {563}, {562}, {561}, {560}, {559}, {558},
    {557}, {556}, {555}, {554}, {553}, {552}
};
  std::vector<std::vector<double>> testdata = {
    //{19},   {32},     {39},     {47},   {57},   {69}, {78},   {87},   {105}, {133},
    //{150},  {176},    {205},   {237},   {266}, {295}, {330}, {377}, {411}, {462},
    //{510},  {560},    {642},   {721},   {790}, {870}, {936}, {1003}, {1097}, {1182},
    //{1279}, {1376},   {1472},  {1578}, {1701}, {1825}, {1948}, {2089}, {2232}, {2372},
    //{2529}, {2697},   {2845},  {3043}, {3230}, {3383}, {3585}, {3792}, {4006}, {4226},
    //{4438}, {4675},   {4924},  {5166}, {5448}, {5734}, {6004}, {6295}, {6603}, {6959},
    //{7317}, {7659},   {8015},  {8360}, {8730}, {9102}, {9475}, {9851}, {10243}, {10671},
    {11062}, {11492}, {11964}, {12432}, {12908}, {13376}, {13873}, {14378}, {14895}, {15408},
    {15971}, {16493}, {17051}, {17622}, {18205}, {18818}, {19415}, {20036}, {20682}, {21322},
    {22045}, {22708}, {23405}, {24091}, {24758}, {25508}, {26228}, {26988}, {27767}, {28533},
    {29338}, {30133}, {30926}, {31761}, {32651}, {33524}, {34344}, {35160}, {36025}, {36932},
    {37843}, {38786}, {39767}, {40786}, {41753}, {42752}, {43759}, {44794}, {45815}, {46803},
    {47871}, {48987}, {50079}, {51129}, {52245}, {53309}, {54544}, {55693}, {56911}, {58086},
    {59356}, {60577}, {61838}, {63023}, {64291}, {65511}, {66790}, {68129}, {69414}, {70748},
    {72078}, {73431}, {74785}, {76148}, {77555}, {78907}
};
  
  double last_loss=0;
  int i=0;
  while(true){
    i++;
    last_loss=0;
    for(int ii=0;ii<inputdata.size();ii++){
      M->load_data_from_outside(testdata[ii]);
      I->input_data(inputdata[ii]);
      
      I->forward();
      N1->forward();
      H1->forward();
      N2->forward();
      H2->forward();
      N3->forward();
      M->forward();
      
      M->backward();
      N3->backward();
      H2->backward();
      N2->backward();
      H1->backward();
      N1->backward();
      I->backward();
      
      I->train();
      H1->train();
      H2->train();
      if(i%10000==0){cout<<"data: "<<testdata[ii][0]<<" predict: "<<H2->layer_output[0]->data<<endl;}
      last_loss+=M->layer_output[0]->data;
    }
    if(i%10000==0){cout<<last_loss/147<<endl;}
  }

}
